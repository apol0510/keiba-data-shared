name: Merge JRA Prediction Files

on:
  push:
    branches:
      - main
    paths:
      - 'jra/predictions/**/*.json'

jobs:
  merge:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # git pushã«å¿…è¦

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # å·®åˆ†ç¢ºèªç”¨

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check for venue-specific files and merge
        id: merge-check
        run: |
          # æ›´æ–°ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD | grep 'jra/predictions/.*\.json' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "merged=false" >> $GITHUB_OUTPUT
            echo "ğŸ“Š No JRA prediction files changed"
            exit 0
          fi

          # ä¼šå ´ã‚³ãƒ¼ãƒ‰ä»˜ããƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ-TKY.jsonç­‰ï¼‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          VENUE_FILES=$(echo "$CHANGED_FILES" | grep -E 'jra/predictions/.*/[0-9]{4}-[0-9]{2}-[0-9]{2}-[A-Z]{3}\.json' || true)

          if [ -z "$VENUE_FILES" ]; then
            echo "merged=false" >> $GITHUB_OUTPUT
            echo "â­ï¸  No venue-specific files found (already merged files only)"
            exit 0
          fi

          echo "ğŸ“‹ ä¼šå ´åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«æ¤œå‡º:"
          echo "$VENUE_FILES"

          # æ—¥ä»˜ã‚’æŠ½å‡ºï¼ˆé‡è¤‡æ’é™¤ï¼‰
          DATES=$(echo "$VENUE_FILES" | sed -E 's|.*/([0-9]{4}-[0-9]{2}-[0-9]{2})-[A-Z]{3}\.json|\1|' | sort -u)

          echo "ğŸ¯ çµ±åˆå¯¾è±¡æ—¥ä»˜:"
          echo "$DATES"

          MERGED_DATES=""
          while IFS= read -r date; do
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“… $date ã®çµ±åˆå‡¦ç†é–‹å§‹"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            # merge-jra-predictions.js ã‚’å®Ÿè¡Œ
            node scripts/merge-jra-predictions.js "$date"

            if [ $? -eq 0 ]; then
              echo "âœ… $date çµ±åˆå®Œäº†"
              if [ -z "$MERGED_DATES" ]; then
                MERGED_DATES="$date"
              else
                MERGED_DATES="$MERGED_DATES, $date"
              fi
            else
              echo "âŒ $date çµ±åˆå¤±æ•—"
            fi
          done <<< "$DATES"

          if [ -n "$MERGED_DATES" ]; then
            echo "merged=true" >> $GITHUB_OUTPUT
            echo "dates=$MERGED_DATES" >> $GITHUB_OUTPUT
          else
            echo "merged=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit merged files
        if: steps.merge-check.outputs.merged == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add jra/predictions/
          if git diff --cached --quiet; then
            echo "â­ï¸  No changes to commit (files already exist)"
          else
            DATES="${{ steps.merge-check.outputs.dates }}"
            git commit -m "ğŸ”„ JRAäºˆæƒ³è‡ªå‹•çµ±åˆ: ${DATES} [Auto-merged by GitHub Actions]"
            git push
            echo "âœ… Pushed merged files for: ${DATES}"
          fi

      - name: Skip notification
        if: steps.merge-check.outputs.merged != 'true'
        run: |
          echo "â­ï¸  Skipped: No venue-specific files to merge"
