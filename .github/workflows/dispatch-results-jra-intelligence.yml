name: Dispatch JRA Results to keiba-intelligence

on:
  push:
    branches:
      - main
    paths:
      - 'jra/results/**/*.json'

jobs:
  dispatch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get changed JRA result files
        id: changed-files
        run: |
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD | grep 'jra/results/.*\.json' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "ğŸ“Š No JRA result files changed"
            exit 0
          fi

          # å„ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ¬ãƒ¼ã‚¹æ•°ã‚’ãƒã‚§ãƒƒã‚¯
          DATES_ARRAY="["
          FIRST=true
          ALL_COMPLETE=true

          while IFS= read -r file; do
            DATE=$(basename "$file" .json)

            # ä¼šå ´åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ-TOK, -KYOç­‰ï¼‰ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆçµ±åˆãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿å‡¦ç†ï¼‰
            if [[ "$DATE" =~ -[A-Z]{3}$ ]]; then
              echo "â­ï¸  ã‚¹ã‚­ãƒƒãƒ—: $DATEï¼ˆä¼šå ´åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰"
              continue
            fi

            # JSONãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ¬ãƒ¼ã‚¹æ•°ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆä¸­å¤®ç«¶é¦¬ã¯10ãƒ¬ãƒ¼ã‚¹ä»¥ä¸Šã§å‡¦ç†ï¼‰
            RACE_COUNT=$(cat "$file" | jq '.races | length')

            echo "ğŸ“‹ $DATE (JRA): $RACE_COUNT ãƒ¬ãƒ¼ã‚¹"

            if [ "$RACE_COUNT" -lt 10 ]; then
              echo "â³ ã‚¹ã‚­ãƒƒãƒ—: $DATE ã¯ ${RACE_COUNT}ãƒ¬ãƒ¼ã‚¹ã®ã¿ï¼ˆ10ãƒ¬ãƒ¼ã‚¹æœªæº€ï¼‰"
              ALL_COMPLETE=false
              continue
            fi

            if [ "$RACE_COUNT" -ge 10 ] && [ "$RACE_COUNT" -lt 12 ]; then
              echo "âš ï¸  æ³¨æ„: $DATE ã¯ ${RACE_COUNT}ãƒ¬ãƒ¼ã‚¹ï¼ˆãƒ¬ãƒ¼ã‚¹ä¸­æ­¢ãƒ»å¤©å€™ä¸è‰¯ã®å¯èƒ½æ€§ï¼‰"
            fi

            echo "âœ… å®Œäº†: $DATE (JRA) ã¯${RACE_COUNT}ãƒ¬ãƒ¼ã‚¹æƒã£ã¦ã„ã¾ã™"

            # 12ãƒ¬ãƒ¼ã‚¹æƒã£ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿datesé…åˆ—ã«è¿½åŠ 
            if [ "$FIRST" = true ]; then
              DATES_ARRAY="${DATES_ARRAY}\"${DATE}\""
              FIRST=false
            else
              DATES_ARRAY="${DATES_ARRAY},\"${DATE}\""
            fi
          done <<< "$CHANGED_FILES"
          DATES_ARRAY="${DATES_ARRAY}]"

          # 12ãƒ¬ãƒ¼ã‚¹æƒã£ãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if [ "$DATES_ARRAY" = "[]" ]; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â­ï¸  å…¨ãƒ•ã‚¡ã‚¤ãƒ«ãŒ12ãƒ¬ãƒ¼ã‚¹æœªæº€ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ï¼ˆé€Ÿå ±ã®ã¿ï¼‰"
            exit 0
          fi

          echo "changed=true" >> $GITHUB_OUTPUT
          echo "dates=$DATES_ARRAY" >> $GITHUB_OUTPUT
          echo "ğŸ¯ Dispatchå¯¾è±¡ (JRA): $DATES_ARRAY"

      - name: Dispatch to keiba-intelligence (with retry)
        if: steps.changed-files.outputs.changed == 'true'
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 2
          max_attempts: 3
          retry_wait_seconds: 10
          command: |
            echo "ğŸ“¤ Dispatching to keiba-intelligence..."
            gh api repos/apol0510/keiba-intelligence/dispatches \
              --method POST \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              -f event_type='results-jra-updated' \
              -f "client_payload={\"dates\":${{ steps.changed-files.outputs.dates }},\"source\":\"keiba-data-shared\",\"venue\":\"jra\",\"trigger\":\"auto\",\"commit_sha\":\"${{ github.sha }}\"}"
        env:
          GH_TOKEN: ${{ secrets.INTELLIGENCE_REPO_DISPATCH_TOKEN }}

      - name: Success notification
        if: steps.changed-files.outputs.changed == 'true'
        run: |
          echo "âœ… Dispatched JRA results to keiba-intelligence"
          echo "   Dates: ${{ steps.changed-files.outputs.dates }}"
          echo "   Event type: results-jra-updated"
          echo "   Target repo: apol0510/keiba-intelligence"
          echo "   Commit: ${{ github.sha }}"
          echo "   Triggered by: ${{ github.actor }}"
          echo ""
          echo "ğŸ“‹ Dispatch details:"
          echo "   - Repository: apol0510/keiba-intelligence"
          echo "   - Event type: results-jra-updated"
          echo "   - Dates: ${{ steps.changed-files.outputs.dates }}"
          echo "   - Source: keiba-data-shared"
          echo "   - Venue: jra"
          echo ""
          echo "ğŸ” To verify dispatch was received:"
          echo "   gh run list --repo apol0510/keiba-intelligence --workflow import-results-jra.yml --limit 3"

      - name: Skip notification
        if: steps.changed-files.outputs.changed != 'true'
        run: |
          echo "â­ï¸  Skipped: No JRA result files changed in this push"

      - name: Failure alert
        if: failure()
        run: |
          echo "ğŸš¨ Dispatch failed!"
          echo "   Dates: ${{ steps.changed-files.outputs.dates }}"
          echo "   Target: apol0510/keiba-intelligence"
          echo "   Event: results-jra-updated"
          echo ""
          echo "âš ï¸  Manual action required:"
          echo "   cd /path/to/keiba-intelligence"
          echo "   gh workflow run import-results-jra.yml -f date=YYYY-MM-DD"
