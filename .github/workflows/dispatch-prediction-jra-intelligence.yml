name: Dispatch JRA Prediction to keiba-intelligence

on:
  push:
    branches:
      - main
    paths:
      - 'jra/predictions/**/*.json'

jobs:
  dispatch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # å·®åˆ†ç¢ºèªç”¨

      - name: Get changed JRA prediction files
        id: changed-files
        run: |
          # æ›´æ–°ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD | grep 'jra/predictions/.*\.json' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "ğŸ“Š No JRA prediction files changed"
            exit 0
          fi

          # å„ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ¬ãƒ¼ã‚¹æ•°ã‚’ãƒã‚§ãƒƒã‚¯
          DATES_ARRAY="["
          FIRST=true

          while IFS= read -r file; do
            FILENAME=$(basename "$file" .json)

            # ä¼šå ´ã‚³ãƒ¼ãƒ‰ä»˜ããƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ2026-02-14-TKY.jsonï¼‰ã¯ã‚¹ã‚­ãƒƒãƒ—
            if [[ "$FILENAME" =~ -[A-Z]{3}$ ]]; then
              echo "â­ï¸  ã‚¹ã‚­ãƒƒãƒ—: $FILENAMEï¼ˆä¼šå ´åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã€çµ±åˆãƒ•ã‚¡ã‚¤ãƒ«ã§å‡¦ç†ï¼‰"
              continue
            fi

            DATE="$FILENAME"

            # JSONãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹é€ ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆçµ±åˆå½¢å¼ or å˜ä¸€ä¼šå ´å½¢å¼ï¼‰
            HAS_VENUES=$(cat "$file" | jq -r 'has("venues")' 2>/dev/null || echo "false")

            if [ "$HAS_VENUES" = "true" ]; then
              # çµ±åˆå½¢å¼ï¼ˆvenuesé…åˆ—ï¼‰
              RACE_COUNT=$(cat "$file" | jq '.totalRaces // 0')
              echo "ğŸ“‹ $DATE (JRAçµ±åˆ): $RACE_COUNT ãƒ¬ãƒ¼ã‚¹"
            else
              # å˜ä¸€ä¼šå ´å½¢å¼ï¼ˆracesé…åˆ—ï¼‰
              RACE_COUNT=$(cat "$file" | jq '.races | length')
              echo "ğŸ“‹ $DATE (JRAå˜ä¸€): $RACE_COUNT ãƒ¬ãƒ¼ã‚¹"
            fi

            if [ "$RACE_COUNT" -lt 12 ]; then
              echo "â³ ã‚¹ã‚­ãƒƒãƒ—: $DATE ã¯ ${RACE_COUNT}ãƒ¬ãƒ¼ã‚¹ã®ã¿ï¼ˆ12ãƒ¬ãƒ¼ã‚¹æœªæº€ï¼‰"
              continue
            fi

            echo "âœ… å®Œäº†: $DATE (JRA) ã¯${RACE_COUNT}ãƒ¬ãƒ¼ã‚¹æƒã£ã¦ã„ã¾ã™"

            # 12ãƒ¬ãƒ¼ã‚¹æƒã£ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿datesé…åˆ—ã«è¿½åŠ 
            if [ "$FIRST" = true ]; then
              DATES_ARRAY="${DATES_ARRAY}\"${DATE}\""
              FIRST=false
            else
              DATES_ARRAY="${DATES_ARRAY},\"${DATE}\""
            fi
          done <<< "$CHANGED_FILES"
          DATES_ARRAY="${DATES_ARRAY}]"

          # 12ãƒ¬ãƒ¼ã‚¹æƒã£ãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if [ "$DATES_ARRAY" = "[]" ]; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â­ï¸  å…¨ãƒ•ã‚¡ã‚¤ãƒ«ãŒ12ãƒ¬ãƒ¼ã‚¹æœªæº€ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—"
            exit 0
          fi

          echo "changed=true" >> $GITHUB_OUTPUT
          echo "dates=$DATES_ARRAY" >> $GITHUB_OUTPUT
          echo "ğŸ¯ Dispatchå¯¾è±¡ (JRA): $DATES_ARRAY"

      - name: Dispatch to keiba-intelligence
        if: steps.changed-files.outputs.changed == 'true'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.INTELLIGENCE_REPO_DISPATCH_TOKEN }}
          repository: apol0510/keiba-intelligence
          event-type: prediction-jra-updated
          client-payload: |
            {
              "dates": ${{ steps.changed-files.outputs.dates }},
              "source": "keiba-data-shared",
              "venue": "jra",
              "trigger": "auto",
              "commit_sha": "${{ github.sha }}"
            }

      - name: Success notification
        if: steps.changed-files.outputs.changed == 'true'
        run: |
          echo "âœ… Dispatched JRA prediction to keiba-intelligence"
          echo "   Dates: ${{ steps.changed-files.outputs.dates }}"
          echo "   Event type: prediction-jra-updated"
          echo "   Target repo: apol0510/keiba-intelligence"

      - name: Skip notification
        if: steps.changed-files.outputs.changed != 'true'
        run: |
          echo "â­ï¸  Skipped: No JRA prediction files changed in this push"
