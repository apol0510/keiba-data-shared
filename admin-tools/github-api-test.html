<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GitHub APIæ¥ç¶šãƒ†ã‚¹ãƒˆ - keiba-data-shared-admin</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      line-height: 1.6;
      color: #2C3E50;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 2rem;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    }

    h1 {
      font-size: 1.75rem;
      margin-bottom: 1rem;
      color: #667eea;
    }

    .section {
      margin: 2rem 0;
      padding: 1.5rem;
      background: #f8f9fa;
      border-radius: 12px;
      border-left: 4px solid #667eea;
    }

    .section h2 {
      font-size: 1.25rem;
      margin-bottom: 1rem;
      color: #333;
    }

    .input-group {
      margin-bottom: 1rem;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #555;
    }

    input[type="text"],
    input[type="password"] {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }

    input:focus {
      outline: none;
      border-color: #667eea;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .log {
      margin-top: 1rem;
      padding: 1rem;
      background: #1e1e1e;
      color: #fff;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .log-entry {
      margin: 0.25rem 0;
    }

    .log-success {
      color: #4ade80;
    }

    .log-error {
      color: #f87171;
    }

    .log-info {
      color: #60a5fa;
    }

    .log-warning {
      color: #fbbf24;
    }

    .status {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.875rem;
      font-weight: 600;
      margin-left: 0.5rem;
    }

    .status-success {
      background: #d1fae5;
      color: #065f46;
    }

    .status-error {
      background: #fee2e2;
      color: #991b1b;
    }

    .status-pending {
      background: #fef3c7;
      color: #92400e;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§ª GitHub APIæ¥ç¶šãƒ†ã‚¹ãƒˆ</h1>
    <p style="color: #666; margin-bottom: 2rem;">
      keiba-data-shared-admin ã® GitHub APIæ¥ç¶šã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚<br>
      ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç®¡ç†ç”»é¢ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã‚³ãƒ”ãƒ¼ã—ã¦ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
    </p>

    <div class="section">
      <h2>âš™ï¸ è¨­å®š</h2>
      <div class="input-group">
        <label for="token">GitHub Personal Access Token</label>
        <input
          type="password"
          id="token"
          placeholder="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
        >
        <small style="color: #666;">
          âš ï¸ ãƒˆãƒ¼ã‚¯ãƒ³ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã®ã¿ãƒ¡ãƒ¢ãƒªã«ä¿æŒã•ã‚Œã¾ã™ã€‚
        </small>
      </div>

      <div class="input-group">
        <label for="filePath">ãƒ†ã‚¹ãƒˆå¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
        <input
          type="text"
          id="filePath"
          placeholder="nankan/results/2026/02/2026-02-03.json"
          value="nankan/results/2026/02/2026-02-03.json"
        >
      </div>
    </div>

    <div class="section">
      <h2>ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</h2>
      <button onclick="runAllTests()" id="runBtn">å…¨ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ</button>
      <button onclick="clearLog()" style="margin-left: 1rem; background: #6b7280;">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>

      <div id="log" class="log">
        <div class="log-info">æº–å‚™å®Œäº†ã€‚ã€Œå…¨ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚</div>
      </div>
    </div>

    <div class="section">
      <h2>ğŸ“‹ ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼</h2>
      <div id="summary" style="line-height: 2;">
        <div>1ï¸âƒ£ èªè¨¼ãƒ†ã‚¹ãƒˆ: <span id="test1" class="status status-pending">æœªå®Ÿè¡Œ</span></div>
        <div>2ï¸âƒ£ ãƒªãƒã‚¸ãƒˆãƒªã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ: <span id="test2" class="status status-pending">æœªå®Ÿè¡Œ</span></div>
        <div>3ï¸âƒ£ ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—ãƒ†ã‚¹ãƒˆ: <span id="test3" class="status status-pending">æœªå®Ÿè¡Œ</span></div>
        <div>4ï¸âƒ£ ãƒ•ã‚¡ã‚¤ãƒ«SHAå–å¾—ãƒ†ã‚¹ãƒˆ: <span id="test4" class="status status-pending">æœªå®Ÿè¡Œ</span></div>
      </div>
    </div>
  </div>

  <script>
    const log = document.getElementById('log');
    const runBtn = document.getElementById('runBtn');

    function addLog(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      log.appendChild(entry);
      log.scrollTop = log.scrollHeight;
    }

    function clearLog() {
      log.innerHTML = '<div class="log-info">ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚</div>';
      document.getElementById('test1').className = 'status status-pending';
      document.getElementById('test1').textContent = 'æœªå®Ÿè¡Œ';
      document.getElementById('test2').className = 'status status-pending';
      document.getElementById('test2').textContent = 'æœªå®Ÿè¡Œ';
      document.getElementById('test3').className = 'status status-pending';
      document.getElementById('test3').textContent = 'æœªå®Ÿè¡Œ';
      document.getElementById('test4').className = 'status status-pending';
      document.getElementById('test4').textContent = 'æœªå®Ÿè¡Œ';
    }

    function updateTestStatus(testId, success) {
      const element = document.getElementById(testId);
      if (success) {
        element.className = 'status status-success';
        element.textContent = 'æˆåŠŸ âœ…';
      } else {
        element.className = 'status status-error';
        element.textContent = 'å¤±æ•— âŒ';
      }
    }

    async function test1_Auth(token) {
      addLog('1ï¸âƒ£ èªè¨¼ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹...', 'info');

      try {
        const response = await fetch('https://api.github.com/user', {
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json',
          }
        });

        if (response.ok) {
          const user = await response.json();
          addLog(`âœ… èªè¨¼æˆåŠŸ: ${user.login}`, 'success');
          addLog(`   - åå‰: ${user.name || 'N/A'}`, 'info');
          addLog(`   - ãƒªãƒã‚¸ãƒˆãƒªæ•°: ${user.public_repos}`, 'info');
          updateTestStatus('test1', true);
          return true;
        } else {
          const error = await response.json();
          addLog(`âŒ èªè¨¼å¤±æ•—: HTTP ${response.status}`, 'error');
          addLog(`   - ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
          updateTestStatus('test1', false);
          return false;
        }
      } catch (error) {
        addLog(`âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        updateTestStatus('test1', false);
        return false;
      }
    }

    async function test2_RepoAccess(token) {
      addLog('\n2ï¸âƒ£ ãƒªãƒã‚¸ãƒˆãƒªã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹...', 'info');

      try {
        const response = await fetch('https://api.github.com/repos/apol0510/keiba-data-shared', {
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json',
          }
        });

        if (response.ok) {
          const repo = await response.json();
          addLog(`âœ… ãƒªãƒã‚¸ãƒˆãƒªã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸ`, 'success');
          addLog(`   - ãƒªãƒã‚¸ãƒˆãƒªå: ${repo.full_name}`, 'info');
          addLog(`   - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ–ãƒ©ãƒ³ãƒ: ${repo.default_branch}`, 'info');
          addLog(`   - å¯è¦–æ€§: ${repo.private ? 'Private' : 'Public'}`, 'info');
          updateTestStatus('test2', true);
          return true;
        } else {
          const error = await response.json();
          addLog(`âŒ ãƒªãƒã‚¸ãƒˆãƒªã‚¢ã‚¯ã‚»ã‚¹å¤±æ•—: HTTP ${response.status}`, 'error');
          addLog(`   - ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
          updateTestStatus('test2', false);
          return false;
        }
      } catch (error) {
        addLog(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        updateTestStatus('test2', false);
        return false;
      }
    }

    async function test3_GetFile(token, filePath) {
      addLog(`\n3ï¸âƒ£ ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹...`, 'info');
      addLog(`   - ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹: ${filePath}`, 'info');

      try {
        const url = `https://api.github.com/repos/apol0510/keiba-data-shared/contents/${filePath}`;
        const response = await fetch(url, {
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json',
          }
        });

        if (response.ok) {
          const data = await response.json();
          addLog(`âœ… ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—æˆåŠŸ`, 'success');
          addLog(`   - ã‚µã‚¤ã‚º: ${data.size} ãƒã‚¤ãƒˆ`, 'info');
          addLog(`   - SHA: ${data.sha}`, 'info');
          updateTestStatus('test3', true);
          return data.sha;
        } else if (response.status === 404) {
          addLog(`âš ï¸  ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“ï¼ˆ404ï¼‰`, 'warning');
          addLog(`   - æ–°è¦ä½œæˆã®å ´åˆã¯æ­£å¸¸ã§ã™`, 'info');
          updateTestStatus('test3', true);
          return null;
        } else {
          const error = await response.json();
          addLog(`âŒ ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—å¤±æ•—: HTTP ${response.status}`, 'error');
          addLog(`   - ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
          updateTestStatus('test3', false);
          return null;
        }
      } catch (error) {
        addLog(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        updateTestStatus('test3', false);
        return null;
      }
    }

    async function test4_GetSha(token, filePath) {
      addLog(`\n4ï¸âƒ£ ãƒ•ã‚¡ã‚¤ãƒ«SHAå–å¾—ãƒ†ã‚¹ãƒˆï¼ˆä¸Šæ›¸ãä¿å­˜ç”¨ï¼‰...`, 'info');

      try {
        const url = `https://api.github.com/repos/apol0510/keiba-data-shared/contents/${filePath}`;
        const response = await fetch(url, {
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json',
          }
        });

        if (response.ok) {
          const data = await response.json();
          addLog(`âœ… SHAå–å¾—æˆåŠŸ`, 'success');
          addLog(`   - SHA: ${data.sha}`, 'info');
          addLog(`   - ã“ã®SHAã‚’ä½¿ã£ã¦ä¸Šæ›¸ãä¿å­˜ãŒå¯èƒ½ã§ã™`, 'success');
          updateTestStatus('test4', true);
          return data.sha;
        } else if (response.status === 404) {
          addLog(`âš ï¸  ãƒ•ã‚¡ã‚¤ãƒ«æœªå­˜åœ¨ï¼ˆæ–°è¦ä½œæˆï¼‰`, 'warning');
          addLog(`   - SHAä¸è¦ï¼ˆnullã§OKï¼‰`, 'info');
          updateTestStatus('test4', true);
          return null;
        } else {
          addLog(`âŒ SHAå–å¾—å¤±æ•—: HTTP ${response.status}`, 'error');
          updateTestStatus('test4', false);
          return null;
        }
      } catch (error) {
        addLog(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        updateTestStatus('test4', false);
        return null;
      }
    }

    async function runAllTests() {
      const token = document.getElementById('token').value.trim();
      const filePath = document.getElementById('filePath').value.trim();

      if (!token) {
        alert('GitHub Personal Access Tokenã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      runBtn.disabled = true;
      clearLog();

      addLog('ğŸš€ GitHub APIæ¥ç¶šãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™\n', 'info');
      addLog('='.repeat(60), 'info');

      // ãƒ†ã‚¹ãƒˆ1: èªè¨¼
      const authOk = await test1_Auth(token);
      if (!authOk) {
        addLog('\nâŒ èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
        runBtn.disabled = false;
        return;
      }

      // ãƒ†ã‚¹ãƒˆ2: ãƒªãƒã‚¸ãƒˆãƒªã‚¢ã‚¯ã‚»ã‚¹
      const repoOk = await test2_RepoAccess(token);
      if (!repoOk) {
        addLog('\nâŒ ãƒªãƒã‚¸ãƒˆãƒªã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
        runBtn.disabled = false;
        return;
      }

      // ãƒ†ã‚¹ãƒˆ3: ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—
      if (filePath) {
        await test3_GetFile(token, filePath);

        // ãƒ†ã‚¹ãƒˆ4: SHAå–å¾—
        await test4_GetSha(token, filePath);
      }

      addLog('\n' + '='.repeat(60), 'info');
      addLog('ğŸ‰ å…¨ãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
      runBtn.disabled = false;
    }
  </script>
</body>
</html>
